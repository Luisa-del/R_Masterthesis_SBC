---
title: "RandomForest Landcover classification - superClass"
author: "Luisa Pflumm"
date: "25 3 2022"
output:
  html_document:
    code_folding: hide
    collapsed: no
    toc: yes
    toc_depth: 4
    toc_float: yes
  <span style="color: red;">text</span>
---

<!-- Sources:  -->
<!-- https://valentinitnelav.github.io/satellite-image-classification-r/#fit_models -->
<!-- https://rspatial.org/raster/rs/5-supclassification.html#reference-data -->
<!-- https://rpubs.com/ials2un/rf_landcover -->
<!-- https://blogs.fu-berlin.de/reseda/classification-in-r/ -->

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages

```{r libraries, include=FALSE}
# Packages for spatial data processing & visualization
library(rgdal)
library(gdalUtils)
library(raster)
library(sf)
library(sp)
library(terra)
library(RStoolbox)
#library(getSpatialData)
library(rasterVis)
library(mapview)
library(grid)

library(RColorBrewer)
library(plotly)
library(grDevices)

# Machine learning packages
library(caret)
library(randomForest)
library(ranger)
library(MLmetrics)
library(nnet)
library(NeuralNetTools)
library(LiblineaR)

# Packages for general data processing and parallel computation
library(data.table)
library(dplyr)
library(stringr)
library(doParallel)
library(snow)
library(parallel)
library(cvms)

# set the temporary folder for raster package operations
rasterOptions(tmpdir = "./cache/temp")
```

# Data preparation

## Raster data

Import multiband raster

```{r}
# Import raster layer

#ls <- raster::stack("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/L8_reducers_2021_months_1-4.tif")
#ls <- raster::stack("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/L8_reducers_2021_months_5-7.tif")
# #ls <- raster::stack("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/L8_reducers_2021_months_5-8.tif")
ls <- raster::stack("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/L8_reducers_2021_months_8-12.tif")
#ls <- raster::stack("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/L8_reducers_2021_months_9-1.tif")
#ls <- raster::stack("D:/Dateien/Uni/Eagle_Master/Masterthesis/Data/Landsat/L8_reducer_2021_months_1-12_nuichua/L8_reducers_2021_months_1-12_nuichua.tif")

x <- ls$B_median@file@name

#(x <- str_sub(x,-31,-5))   # 1-4, 5-7, 9-1
(x <- str_sub(x,-32,-5))   # 8-12 
# (x <- str_sub(x,-40,-13))  # 1-12
```

Select bands (predictors)

```{r}
landsat <- ls[[-length(names(ls))]]
names(landsat)
```
Plot falsecolor median image

```{r, message=FALSE, warning=FALSE}
r <- landsat[[c(1,4,7,10,13,16)]]
viewRGB(r, r=5, g=4, b=2, layer.name=x)
```

Plot valid pixels of scene

```{r, message=FALSE, warning=FALSE}
v <- ls[["valid_pixels"]]
v@data@values <- getValues(v)
levels(v)=data.frame(ID=seq(min(v@data@values),max(v@data@values)), val=seq(min(v@data@values),max(v@data@values)))
mapview(v, layer.name="valid pixels")
```

## Training data

Import training polygons

```{r, message=FALSE, warning=FALSE}
# Import boundary of aoi
aoi <- shapefile("D:/Dateien/Uni/Eagle_Master/Masterthesis/Data/Nui_Chua_NP.shp")
# Import polygons
samp <- shapefile("D:/Dateien/Uni/Eagle_Master/Masterthesis/Data/trainingdata/Nuichua/LC_classes_tejas.shp")

# Need to have a numeric id for each class - helps with rasterization later on.
samp@data$class_id <- as.integer(factor(samp@data$class_id))
samp@data$plot_id <- as.integer(factor(samp@data$plot_id))
samp@data$binary_id <- as.integer(factor(samp@data$binary_id))

# Set as data table
setDT(samp@data)
```

Define class parameters

```{r}
# set class names
classes <- c("Evergreen.Forest","Dry.Forest","Costal.Shrubland","Inland.Shrubland",
  "Bare.Ground","Agriculture","Water","Built.up")
# define color palette
cpal <- c("#162700","#a1a733","#5fa00a","#37590a","#f86b05","#c22341","#0500ff","#020103")
cpal_az <- c("#c22341","#f86b05","#020103","#5fa00a","#a1a733","#162700","#37590a","#0500ff")

# save class definitions in df
classdf <- data.frame(classvalue = c(1,2,3,4,5,6,7,8),
                      classnames = classes,
                      color = cpal,
                      color_az = cpal_az)
```

<!-- ### Split dataset into training and validation -->

Rasterize training polygons

```{r}
# Create raster template
template_rst <- raster(extent(landsat$B_median), # band B2 has resolution 10 m
                       resolution = 30,
                       crs = projection(landsat$B_median))
#samp_rst <- raster::rasterize(samp, template_rst, field = "class_id") #-> not working, don't know why :(
samp_rst <- raster("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/LC_tejas_rasterized.tif") # import sample raster created in QGIS

#mapview(samp_rst)
```

Create random stratified sample points from training polygons

*Sample Methods:*

* *random: Validation samples were picked completely random. Each pixel within the study area has the same probability of being picked.*

* *stratified random: The proportions of the classes in the validation samples correspond to the area proportion on the classification map.That is, the larger the area of class on the map, the more samples will be drawn from it.*

* *equalized stratified random: Ensures, that each classâ€™s sample size is exactly the same regardless of area of class on the map*

```{r}
points <- sampleStratified(samp_rst, size = 200, xy=TRUE, na.rm = TRUE, sp = TRUE)
points <- points[,-1]
colnames(points@data)[3] = "class_id"
```

Split random stratified samples into training and validation

```{r}
# # Add ID
# points@data$ID <- seq.int(nrow(points@data))

split <- 0.7

# Convert points to data table
poi <- data.frame(points)
poi <- poi[1:4]
poi <- setDT(poi)

# A stratified random split of the data
set.seed(321)
idx_train <- createDataPartition(poi$class_id,
                                 p = split, # percentage of data as training
                                 list = FALSE)
train <- poi[idx_train]
test <- poi[-idx_train]

# Convert to sp objects
train_sp <- SpatialPointsDataFrame(coords = train[, .(x, y)],
                                 data = train %>% select(-c("x","y")) ,
                                 proj4string = samp_rst@crs)
test_sp <- SpatialPointsDataFrame(coords = test[, .(x, y)],
                                 data = test %>% select(-c("x","y")) ,
                                 proj4string = samp_rst@crs)

# Convert class id to factor and set levels to avoid error in training part
train_sp@data$class_id <- as.factor(train_sp@data$class_id)
levels(train_sp@data$class_id) <- as.character(classdf$classnames)

test_sp@data$class_id <- as.factor(test_sp@data$class_id)
levels(test_sp@data$class_id) <- as.character(classdf$classnames)
```

Training samples split into 70% for training and 30% for validation

```{r}
table(train_sp@data$class_id)
table(test_sp@data$class_id)
```

*--> Raster and vector data have same CRS? If not, reproject training data.*

Plot training data. 

In the layer panel (left side) you can select/unselect the different layers and choose other background themes.

```{r}
t1 <- mapview(samp, zcol = "landcover", layer.name = "Tejas landcover classes",
        col.regions = list("#c22341","#f86b05","#020103","#5fa00a","#a1a733","#162700","#37590a","#0500ff"),
        alpha.regions=0.9)
m1 <- mapview(points)
m_train <- mapview(train_sp, col.regions="magenta", color="magenta",layer.name="Training samples",cex=0.5)
m_test <- mapview(test_sp, col.regions="cyan",color="cyan",layer.name="Validation samples",cex=0.5)

t1 +
  #m1 +
  m_train +
  m_test 
```

<!-- ### Alternativ: import already split train and test polygons -->

<!-- worse accuracy than first approach!! -->

<!-- ```{r} -->
<!-- # import training partition (70%) -->
<!-- train_sp <- shapefile("D:/Dateien/Uni/Eagle_Master/Masterthesis/Data/trainingdata/Nuichua/LC_tejas_split/LC_classes_tejas_70percent_training.shp") -->

<!-- # convert class id to factor and set levels to avoid error -->
<!-- train_sp@data$class_id <- as.factor(train_sp@data$class_id) -->
<!-- levels(train_sp@data$class_id) <- as.character(classdf$classnames) -->

<!-- # import validation partition (30%) -->
<!-- test_sp <- shapefile("D:/Dateien/Uni/Eagle_Master/Masterthesis/Data/trainingdata/Nuichua/LC_tejas_split/LC_classes_tejas_30percent_validation.shp") -->

<!-- # convert class id to factor and set levels to avoid error -->
<!-- test_sp@data$class_id <- as.factor(test_sp@data$class_id) -->
<!-- levels(test_sp@data$class_id) <- as.character(classdf$classnames) -->
<!-- ``` -->

<!-- *-> Raster and vector data have same CRS? If not, reproject training data.* -->

<!-- Plot training data.  -->

<!-- In the layer panel (left side) you can select/unselect the different layers and choose other background themes. -->

<!-- ```{r} -->
<!-- t1 <- mapview(samp, zcol = "landcover", layer.name = "Tejas landcover classes", -->
<!--         col.regions = list("#c22341","#f86b05","#020103","#5fa00a","#a1a733","#162700","#37590a","#0500ff"), -->
<!--         alpha.regions=0.9) -->

<!-- t2 <- mapview(train_sp, layer.name = "70% training", -->
<!--         color = "magenta", col.regions="magenta",alpha.regions=0, lwd=1)  -->

<!-- t3 <- mapview(test_sp, layer.name = "30% validation", -->
<!--         color = "cyan", col.regions="cyan",alpha.regions=0, lwd=1) -->

<!-- t1 + t2 + t3 -->
<!-- ``` -->

# RF classification

Set parameters and run superClass() from RStoolbox

```{r }
# SC_prob <- superClass(landsat,
#                   train_sp,
#                   valData = test_sp,
#                   responseCol = "class_id",
#                   nSamples = 1000,           # ignored if input is of class spatial points
#                   polygonBasedCV = TRUE,     # ignored if input is of class spatial points
#                   trainPartition = 0.7,      # ignored if input valData is provided
#                   model = "rf",
#                   tuneLength = 3,
#                   kfold = 5,
#                   minDist = 2,
#                   mode = "classification",   # regression
#                   predict = TRUE,
#                   predType = "prob",         # raw
#                   #filename = paste0("D:/Dateien/Dropbox (ScreenForBio)/Projects/SBC/SBC_analysis_Nui_Chua/Initial_LC_Luisa/Nuichua/SC_prob_",x,".tif"),
#                   verbose = TRUE)
#                   #overwrite = TRUE)
# save(SC_prob, file = paste0("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/SC/SC_prob_",x,".RData"))

load("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/SC/SC_prob_L8_reducers_2021_months_5-7.RData")
```

## Multiband probability layer

```{r}
prob_stack <- SC_prob$map
rasterVis::levelplot(prob_stack)
```

```{r, warning=FALSE}
# for (i in 1:length(classdf$classvalue)){
#   mycol <- colorRampPalette(c("white", classdf$color[i]))
#   print(mapview(prob_stack[[i]], col.regions=mycol, layer.name=classdf$classnames[i]))
# }

mycol1 <- colorRampPalette(c("white", classdf$color[1]))
mycol2 <- colorRampPalette(c("white", classdf$color[2]))
mycol3 <- colorRampPalette(c("white", classdf$color[3]))
mycol4 <- colorRampPalette(c("white", classdf$color[4]))
mycol5 <- colorRampPalette(c("white", classdf$color[5]))
mycol6 <- colorRampPalette(c("white", classdf$color[6]))
mycol7 <- colorRampPalette(c("white", classdf$color[7]))
mycol8 <- colorRampPalette(c("white", classdf$color[8]))

mapview(prob_stack[[1]], col.regions=mycol1, layer.name=classdf$classnames[1])
mapview(prob_stack[[2]], col.regions=mycol2, layer.name=classdf$classnames[2])
mapview(prob_stack[[3]], col.regions=mycol3, layer.name=classdf$classnames[3])
mapview(prob_stack[[4]], col.regions=mycol4, layer.name=classdf$classnames[4])
mapview(prob_stack[[5]], col.regions=mycol5, layer.name=classdf$classnames[5])
mapview(prob_stack[[6]], col.regions=mycol6, layer.name=classdf$classnames[6])
mapview(prob_stack[[7]], col.regions=mycol7, layer.name=classdf$classnames[7])
mapview(prob_stack[[8]], col.regions=mycol8, layer.name=classdf$classnames[8])
```

## Singleband classification layer

```{r, warning=FALSE,message=FALSE}
# Combine probability layers to one final layer product by selecting the max probability value
which.max2 <- function(x, ...) which.max(x)           # helper function to absorb "na.rm"
raw <-  stackApply(prob_stack, rep(1,8), fun=which.max2, na.rm=NULL)
levels(raw)=data.frame(ID=1:8, class=classdf$classnames)

mapview(raw, col.regions=list("#162700","#a1a733","#5fa00a","#37590a","#f86b05","#c22341","#0500ff","#020103"), alpha.regions=1, layer.name="L8 LC classification")
```



## Model evaluation

### Accuracy assessment 

Confusion matrix, overall accuracy, kappa, class statistics

```{r}
# validation performance estimates based on independent validation (confusion matrix etc.)
SC_prob$validation$performance
```

### Predictor importance

```{r}
caret::varImp(SC_prob$model)$importance %>% 
  as.matrix %>% 
  plot_ly(x = colnames(.), y = rownames(.), z = ., type = "heatmap",
          width = 600, height = 600)
```

### Modelstatistics

```{r}
# the fitted model
SC_prob$model

# model fit statistics
SC_prob$modelFit

# # indexes of samples used for training
# SC_prob$training
# 
# # actual pixel coordinates plus reference and predicted values used for validation
# SC_prob$validation$validationSamples
# 
# # validation polygpns (clipped with mindist to training geometries)
# SC_prob$validation$validationGeometry
# 
# # the predicted raster
# SC_prob$map
# 
# # data.frame containing an integer <-> label mapping
# SC_prob$classMapping
```


# Export

```{r}
# exp1 <- terra::rast(prob_stack)
# writeRaster(exp1,paste0("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/SC/SC_prob_",x,".tif"))
# 
# exp2 <- terra::rast(raw)
# writeRaster(exp2,paste0("D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/SC/SC_raw_",x,".tif"))
# 
# #save.image(file="D:/Dateien/Uni/Eagle_Master/Masterthesis/R_Masterthesis_SBC/testing/SC/SC_prob_L8_2021_months_1-4_wholeworkspace.RData")
```






